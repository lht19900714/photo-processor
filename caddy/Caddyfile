{
    # Let's Encrypt production ACME (requires standard ports 80/443)
    acme_ca https://acme-v02.api.letsencrypt.org/directory

    # For testing, use staging to avoid rate limits:
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # Email for Let's Encrypt notifications (recommended)
    # Replace with your actual email for certificate expiry notifications
    # email your-email@example.com
}

# HTTPS server (standard port 443)
photo.wangdake.de {
    # Serve frontend static files
    root * /srv

    # Enable compression
    encode gzip zstd

    # API proxy - must be before file_server
    handle /api/* {
        reverse_proxy server:22000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}

            # Timeout settings for long-running requests
            transport http {
                read_timeout 86400s
                write_timeout 86400s
                dial_timeout 30s
            }

            # Health check for upstream
            health_uri /health
            health_interval 30s
            health_timeout 10s
        }
    }

    # WebSocket proxy
    handle /ws {
        reverse_proxy server:22000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}

            # WebSocket timeout configuration
            transport http {
                read_timeout 86400s
                write_timeout 86400s
                dial_timeout 10s
            }
        }
    }

    # Health check endpoint
    handle /health {
        respond "OK" 200
    }

    # Static assets with long cache
    @static path /assets/*
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Vue Router - SPA fallback
    handle {
        try_files {path} /index.html
        file_server
    }

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        # HSTS - enable after confirming HTTPS works
        # Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }
}

# HTTP health check + redirect (standard port 80)
# Health endpoint must respond before redirect for Docker health checks
http://photo.wangdake.de {
    handle /health {
        respond "OK" 200
    }

    handle {
        redir https://photo.wangdake.de{uri} permanent
    }
}
